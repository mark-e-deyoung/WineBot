x-winebot-env: &winebot_env
  WINEPREFIX: /wineprefix
  DISPLAY: :99
  SCREEN: 1280x720x24
  APP_EXE: ${APP_EXE:-}
  APP_ARGS: ${APP_ARGS:-}
  WORKDIR: ${WORKDIR:-}
  APP_NAME: ${APP_NAME:-}
  INIT_PREFIX: ${INIT_PREFIX:-1}
  WINEARCH: ${WINEARCH:-win64}
  RUN_AUTOMATION: ${RUN_AUTOMATION:-0}
  AUTOMATION_CMD: ${AUTOMATION_CMD:-}
  WINEBOT_RECORD: ${WINEBOT_RECORD:-0}
  WINEBOT_INPUT_TRACE: ${WINEBOT_INPUT_TRACE:-1}
  WINEBOT_INPUT_TRACE_WINDOWS: ${WINEBOT_INPUT_TRACE_WINDOWS:-1}
  WINEBOT_INPUT_TRACE_RECORD: ${WINEBOT_INPUT_TRACE_RECORD:-0}
  WINEBOT_INPUT_TRACE_NETWORK: ${WINEBOT_INPUT_TRACE_NETWORK:-0}
  WINEBOT_INPUT_TRACE_NETWORK_SAMPLE_MS: ${WINEBOT_INPUT_TRACE_NETWORK_SAMPLE_MS:-10}
  WINEBOT_USER_DIR: ${WINEBOT_USER_DIR:-}
  API_TOKEN: ${API_TOKEN:-}
  ENABLE_WINEDBG: ${ENABLE_WINEDBG:-0}
  ENABLE_API: ${ENABLE_API:-1}
  WINEDBG_MODE: ${WINEDBG_MODE:-}
  WINEDBG_PORT: ${WINEDBG_PORT:-}
  WINEDBG_NO_START: ${WINEDBG_NO_START:-}
  WINEDBG_COMMAND: ${WINEDBG_COMMAND:-}
  WINEDBG_SCRIPT: ${WINEDBG_SCRIPT:-}
  ENABLE_VNC: ${ENABLE_VNC:-}
  VNC_PORT: ${VNC_PORT:-5900}
  NOVNC_PORT: ${NOVNC_PORT:-6080}
  NOVNC_HOST: ${NOVNC_HOST:-}
  NOVNC_TITLE: ${NOVNC_TITLE:-}
  VNC_PASSWORD: ${VNC_PASSWORD:-}
  VNC_BIND: ${VNC_BIND:-}
  BUILD_INTENT: ${BUILD_INTENT:-rel}
  WINEBOT_SUPPORT_MODE: ${WINEBOT_SUPPORT_MODE:-0}
  WINEBOT_SUPPORT_MODE_MINUTES: ${WINEBOT_SUPPORT_MODE_MINUTES:-60}
  WINEDEBUG: ${WINEDEBUG:-}

x-winebot-base: &winebot_base
  build:
    context: ..
    dockerfile: docker/Dockerfile
    target: intent-${BUILD_INTENT:-rel}
    args:
      BASE_IMAGE: ${BASE_IMAGE:-ghcr.io/mark-e-deyoung/winebot-base:base-2026-02-09}
      VCS_REF: ${VCS_REF:-local}
      BUILD_DATE: ${BUILD_DATE:-local}
      SOURCE_REPO: ${SOURCE_REPO:-https://github.com/mark-e-deyoung/WineBot}
      BUILD_INTENT: ${BUILD_INTENT:-rel}
  image: winebot:${WINEBOT_IMAGE_VERSION:-local}-${BUILD_INTENT:-rel}
  volumes:
    - wineprefix:/wineprefix
    - ../apps:/apps:ro
    - ../automation/assets:/automation/assets:ro
    - ../artifacts:/artifacts

services:
  winebot:
    <<: *winebot_base
    profiles:
      - headless
    environment:
      <<: *winebot_env
      MODE: headless
    ports: []

  winebot-interactive:
    <<: *winebot_base
    profiles:
      - interactive
    environment:
      <<: *winebot_env
      MODE: interactive
      ENABLE_VNC: "1"
      VNC_PASSWORD: ${VNC_PASSWORD:-winebot}
    ports:
      - "8000:8000"
      - "5353:5353/udp"
      - "5900:5900"
      - "6080:6080"
      - "${WINEDBG_PORT:-2345}:${WINEDBG_PORT:-2345}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 10s

  test-runner:
    build:
      context: ../
      dockerfile: tests/e2e/Dockerfile
    profiles:
      - test
    entrypoint: []
    depends_on:
      winebot-interactive:
        condition: service_healthy
    environment:
      - PLAYWRIGHT_BROWSERS_PATH=/ms-playwright
      - API_URL=http://winebot-interactive:8000
    volumes:
      - ..:/work
      - ../artifacts:/output
    command: >
      bash -c "sleep 15 && pytest -v -s tests/test_api.py tests/test_input_validation.py tests/e2e"

  lint-runner:
    build:
      context: ../
      dockerfile: tests/e2e/Dockerfile
    profiles:
      - lint
    entrypoint: []
    volumes:
      - ..:/work
    command: >
      bash -c "ruff check . && mypy api automation"

volumes:
  wineprefix:
