# WineBot Status - 2026-02-09

## Current State
- Branch: `main`
- Latest stable release: `0.9.2`
- Release run for `0.9.2` completed successfully:
  - https://github.com/mark-e-deyoung/WineBot/actions/runs/21811028488
- Invite-only contribution policy automation is live on `main`.

## Accomplishments This Session
1. Release pipeline correctness and security hardening:
- Added disk-pressure mitigations for Trivy in `.github/workflows/release.yml`.
- Fixed broken `sigstore/cosign-installer` pin in `.github/workflows/release.yml`.
- Added release guardrails:
  - enforce release target `main` for release events,
  - require branch protection on `main`,
  - validate release tag format before publish.
- Added post-publish artifact verification job:
  - verifies cosign signature,
  - validates SBOM presence (`cosign download sbom`).

2. Reliability and bounded-resource improvements:
- Updated `api/routers/lifecycle.py` to use bounded tail reads for lifecycle events (`deque(maxlen=limit)`), avoiding full-file read amplification.
- Added regression tests for:
  - bounded `/input/events` tail filtering behavior,
  - bounded `/lifecycle/events` parsing behavior,
  - concurrent `/input/trace/start` idempotency (single spawn),
  - concurrent `/input/trace/stop` idempotency (single stop command).
- Added soak diagnostic script `scripts/diagnose-trace-soak.sh` to monitor long-run session/log growth and PID 1 RSS thresholds.

3. Contribution policy enforcement:
- Added `.github/workflows/approved-issues-only.yml`.
- Added `.github/workflows/approved-prs-only.yml`.
- Added `CONTRIBUTING.md` with invite-only collaborator policy and private security reporting guidance.

4. Image optimization and API hardening:
- Refactored `docker/Dockerfile` with multi-stage builds and intent-based inheritance.
- Achieved ~35% reduction in production image size (rel/rel-runner).
- Switched to `opencv-python-headless` to prune X11 library bloat from the core automation stack.
- Integrated `scripts/diagnose-trace-soak.sh` into `.github/workflows/nightly-soak.yml`.
- Fixed exception handling for path validation in session resume/suspend APIs.
- Added `tests/test_lifecycle_hardened.py` covering concurrent resume/suspend and broker state transitions.

## Commits
- `10d74f5` - Mitigate Trivy disk exhaustion in release smoke scan
- `2b8b033` - Fix cosign installer action pin in release workflow
- `8ad0bd6` - Add 2026-02-09 status snapshot for release workflow fixes
- `f833032` - Enforce invite-only issue and PR participation
- `f3ad5bd` - Harden release verification and add reliability regression coverage
- [LOCAL] - Optimize Dockerfile and harden lifecycle API with expanded tests

## Known Gaps / Risks
- `stable` tag should be aligned to the exact `0.9.2`/`latest` manifest digest by direct retag after package-auth refresh (one-time metadata action).
- Deferred: GH auth token needs full reset (`gh auth logout/login` with package scopes) before applying GHCR base-image aliases `winebot-base:latest` and `winebot-base:stable` to digest `sha256:d19bd8bdedbb2225d908cbfb7f26218a728aa0581bcf74e6a55dfee7ab270355`.
- Full-repo lint debt remains.

## Recommended Next Steps
1. Run one-time GHCR retag to make `stable` exactly match `latest`/`0.9.2` digest.
2. Monitor initial runs of `.github/workflows/nightly-soak.yml`.
3. Prune `base-runtime` further by splitting system dependencies into granular layers if size growth resumes.

## Session Resume Notes
- Key files changed for the latest hardening wave:
  - `docker/Dockerfile`
  - `api/routers/lifecycle.py`
  - `requirements-rel.txt`
  - `.github/workflows/nightly-soak.yml`
  - `tests/test_lifecycle_hardened.py`
